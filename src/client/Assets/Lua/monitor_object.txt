
-- test_mem.txt ------------------------------------------------
-- author:  许德纪
-- date:    2017.11.03
-- ver:     1.0
-- desc:    记录内存测试对象
-------------------------------------------------------------------

local require = require
local table = table
local pairs = pairs
local debug = debug
local print = print
local tostring = tostring
local type =type
local setmetatable = setmetatable
local collectgarbage = collectgarbage
local io = io

local game = require "game"
local event = require "event"
local log = require "log"

local GC = CS.System.GC
local IsInEditor = CS.War.Script.Utility.IsInEditor

module("monitor_object")

--是否启用监控功能
local bEnableMonitor = IsInEditor and IsInEditor()

--全局监控表
local  monitor_objects = {"monitor_object"}
setmetatable(monitor_objects,{__mode='k'})

--监控对象,后面输出的时候,将以name作为key
function Monitor_Object(name,o)
	--bEnableMonitor = false
	--不启用监控功能，什么也不做
	if bEnableMonitor== false then 
		return
	end

	if nil==name then
		log.Warning("无法监控 空名字的对象"..tostring(o))
		return
	end
	
	
	if  type(name)~="string" then
		log.Warning("监控对象的名字，请填string类型"..tostring(o))
		return
	end
	
	
	if nil==o then
		log.Warning("无法监控 空对象"..name)
		return
	end

	monitor_objects[o] = tostring(name)
end

--打印现在存储的对象
function Dump_Object()
	
	if  bEnableMonitor==nil or  false==bEnableMonitor then
		return 
	end
	
	GC.Collect()
	collectgarbage("collect")
	
	GC.Collect()
	collectgarbage("collect")
	
	local t_dump = {}
	for k,v in pairs(monitor_objects) do
		if t_dump[v]==nil then
			t_dump[v] = 1
		else
			t_dump[v] = t_dump[v]+1
		end
	end
	
	local file = io.open("d:\\monitor_object.txt", "w")


	--local str_dump = ""
	for k,v in pairs(t_dump) do
		local strlog = "当前遗留的对象,名称 :"..tostring(k).."	： 数量: "..tostring(v).."\r\n"
		log.Warning(strlog)
		if nil ~=file then
			file:write(strlog)
		end
		--str_dump =str_dump.."当前遗留的对象,名称 :"..k.."	： 数量: "..tostring(v).."\n"
	end
	
	if nil~=file then
		file:close()
	end
end

--进入匹配状态
function OnActorLoginFinish(eventName, curState)
	Dump_Object()
end

--event.Register(event.ACTOR_LOGIN_FINISH, OnActorLoginFinish)